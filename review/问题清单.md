# 项目 Bug / 风险问题清单

> 范围：`Claude_clone/` + `Claude_clone_backend/` 静态检查结果。
> 说明：以下为"上线前建议优先处理"的问题，按严重级别排序。
> 最后验证时间：2026-02-23，全部 14 个问题已修复并部署。

## P0（高危 / 可能导致服务不可用或严重安全问题）

### 1. ✅ 聊天并发计数存在泄漏，错误请求会永久占用并发槽位
- 状态：**已修复**
- 修复：将并发计数增加移到所有前置校验（额度检查、附件校验）之后。

### 2. ✅ 聊天异常处理块引用了 try 块内的变量，存在 ReferenceError 风险
- 状态：**已修复**
- 修复：将 `poolKey`、`clientClosed` 提升到 `try` 之前声明并初始化为 `null`/`false`。

### 3. ✅ 对话压缩功能调用了不存在的方法，功能实际不可用
- 状态：**已修复**
- 修复：改为 `keyPool.acquire(conversationId)` 并适配返回值格式，添加 `try/finally` 确保 `keyPool.release()`。

### 4. ✅ 网页抓取工具缺少内网/本机地址拦截，存在 SSRF 风险
- 状态：**已修复**
- 修复：在 `webFetch.js` 中添加私网 IP 段（10.x、127.x、172.16-31.x、192.168.x、169.254.x）和特殊地址（localhost、metadata 等）拦截。

---

## P1（中高风险 / 安全、稳定性、用户体验明显受损）

### 5. ✅ 重置密码后未强制失效既有会话
- 状态：**已修复**
- 修复：重置密码成功后执行 `DELETE FROM sessions WHERE user_id = ?`。

### 6. ✅ 代码执行生成图片为公开静态目录，未鉴权
- 状态：**已修复**
- 修复：在 `index.js` 中为 `/api/code-images` 路由添加 `auth` 中间件。

### 7. ✅ 对话详情接口向前端返回服务器本地文件路径
- 状态：**已修复**
- 修复：从附件响应对象中移除 `file_path` 字段。

### 8. ✅ 上传配额检查与扣减非原子，存在并发穿透
- 状态：**已修复**
- 修复：用 `db.transaction()` + `SELECT ... FOR UPDATE` 实现原子配额检查与预扣减，写文件失败时回退。

### 9. ✅ 发送验证码"先入库后发信"，发信失败会留下有效验证码
- 状态：**已修复**
- 修复：注册和忘记密码两处，发信失败时执行 `DELETE FROM verification_codes WHERE id = ?`。

### 10. ✅ 前端 SSE 解析在"无文本回复"场景可能不触发完成回调
- 状态：**已修复**
- 修复：流结束时无条件调用 `onDone(fullText)`（含空字符串场景）。

### 11. ✅ 代码执行结果上报忽略 HTTP 失败，后端会等到超时
- 状态：**已修复**
- 修复：`sendCodeResult` 中添加 `resp.ok` 检查，失败时 console.error 记录。

### 12. ✅ 配置文件内置了默认搜索 API Key
- 状态：**已修复**
- 修复：移除 `config.js` 中硬编码默认值，改为空字符串 fallback，密钥通过 `.env` 注入。

---

## P2（一般问题 / 但建议修复以提升可维护性）

### 13. ✅ 新建会话触发计数重复加 2 次
- 状态：**已修复**
- 修复：删除 `handleNewChat` 中重复的 `setNewChatKey` 和 `setRefreshTrigger` 调用。

### 14. ✅ 后端残留调试日志，可能泄露用户输入与 SQL 参数
- 状态：**已修复**
- 修复：删除 `conversations.js` 中 3 处 DEBUG console.log。

---

## 附：本次只读验证

- TypeScript 编译检查：通过（`tsc --noEmit`）
- 后端 JS 语法检查：通过（`node --check`）

